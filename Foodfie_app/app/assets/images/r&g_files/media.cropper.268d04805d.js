(window.$WP=window.$WP||[]).push({id:"@ta/media.cropper",d:["vendor-babel","vendor-react-libs","ta-platform","ta-common","@ta/events.window-resize","@ta/input.slider"],e:["./packages/media/cropper/cropper-main.jsx"],x:{"./packages/media/cropper/cropper-main.jsx":["Cropper"]},m:{"./packages/media/cropper/cropper-main.jsx":function(e,o,t){"use strict";t.r(o);var a=t("@babel/runtime/helpers/esm/classCallCheck"),n=t.n(a),r=t("@babel/runtime/helpers/esm/createClass"),i=t.n(r),s=t("@babel/runtime/helpers/esm/possibleConstructorReturn"),c=t.n(s),p=t("@babel/runtime/helpers/esm/getPrototypeOf"),m=t.n(p),h=t("@babel/runtime/helpers/esm/inherits"),u=t.n(h),l=t("@babel/runtime/helpers/esm/assertThisInitialized"),g=t.n(l),d=t("@babel/runtime/helpers/esm/defineProperty"),v=t.n(d),f=t("react"),z=t("@ta/common.classnames"),w=t.n(z),S=t("@ta/styleguide.loading"),C=t("@ta/events.window-resize"),P=t.n(C),b=t("@ta/input.slider"),I=t("@ta/media.common"),M={canvasWrapper:"media-cropper-Cropper__canvasWrapper--1M93f",canvas:"media-cropper-Cropper__canvas--1A8wq",cropShadow:"media-cropper-Cropper__cropShadow--VUz9J",loadingSpinner:"media-cropper-Cropper__loadingSpinner--3dZci",zoomWrap:"media-cropper-Cropper__zoomWrap--2_SEM",zoomIconSmall:"media-cropper-Cropper__zoomIconSmall--1tVzo",zoomIconBig:"media-cropper-Cropper__zoomIconBig--36vYF",zoomSlider:"media-cropper-Cropper__zoomSlider--HI97U"},D=100,E=function(e){function o(e){var t;return n()(this,o),t=c()(this,m()(o).call(this,e)),v()(g()(g()(t)),"setImage",function(){t.props.url&&(t.image=new Image,t.image.onload=t.imageLoaded,t.image.crossOrigin="Anonymous",t.image.src=t.props.url)}),v()(g()(g()(t)),"canvasRef",f.createRef()),v()(g()(g()(t)),"image",void 0),v()(g()(g()(t)),"prevTouchPositions",new Map),v()(g()(g()(t)),"pinchInProgress",!1),v()(g()(g()(t)),"cropImage",function(){if(t.image){var e=t.state,o=e.cropCenter,a=e.cropSize,n=e.zoomCurrent,r=Math.round(o.x-a.width/2/n),i=Math.round(o.y-a.height/2/n),s=Math.round(a.width/n),c=Math.round(a.height/n),p={x:r,y:i,cropWidth:s,cropHeight:c,originalImageHeight:t.image.height,originalImageWidth:t.image.width},m=Object(I.cropImageToJpegUrl)(t.image,t.props.mimeType,r,i,s,c);t.props.cropImageCallback({dataUrl:m,cropParams:p})}}),v()(g()(g()(t)),"imageLoaded",function(){if(!t.canvasRef.current||!t.image)throw new Error("Image loaded, but refs are not set.  Should not be able to get here.");var e=new I.Dimension(t.image.width,t.image.height);t.setState({imageLoaded:!0,imageSize:e})}),v()(g()(g()(t)),"calculateCropSizeAndZoom",function(){if(!t.canvasRef.current||!t.image)throw new Error("Image loaded, but refs are not set.  Should not be able to get here.");var e,o=t.canvasRef.current,a=t.props,n=a.cropWidth,r=a.cropHeight,i=a.imageFitDirection,s=0===n?o.clientWidth:n,c=0===r?o.clientHeight:r,p=new I.Dimension(s,c),m=p.width/t.image.width,h=p.height/t.image.height;e="horizontal"===i?m:"vertical"===i?h:Math.max(m,h),t.image.height*e<p.height&&(e=h);var u=t.state.imageSize;return{cropSize:p,zoom:e,cropCenter:new I.Point(u.width/2,u.height/2)}}),v()(g()(g()(t)),"updateCanvas",function(){var e=t.state,o=e.canvasSize,a=e.imageSize,n=e.cropCenter,r=e.zoomCurrent;if(t.state.imageLoaded&&t.canvasRef.current&&t.image){var i=t.canvasRef.current,s=new I.Dimension(i.clientWidth,i.clientHeight);i.width=s.width,i.height=s.height;var c=Math.round(a.width*r),p=Math.round(a.height*r),m=s.width/2,h=s.height/2,u=Math.round(m-n.x*r),l=Math.round(h-n.y*r),g=i.getContext("2d");if(g.clearRect(0,0,s.width,s.height),g.drawImage(t.image,u,l,c,p),!o.equals(s)){var d=t.calculateCropSizeAndZoom();t.setState({canvasSize:s,cropSize:d.cropSize,zoomMin:d.zoom,zoomCurrent:d.zoom,cropCenter:d.cropCenter,zoomSliderValue:0})}}}),v()(g()(g()(t)),"mouseDown",function(e){t.props.enabled&&(e.preventDefault(),t.setState({isDragging:!0,prevPointerPosition:new I.Point(e.pageX,e.pageY)}))}),v()(g()(g()(t)),"stopDragging",function(){t.setState({isDragging:!1})}),v()(g()(g()(t)),"mouseMove",function(e){if(t.state.isDragging&&t.props.enabled){e.preventDefault();var o=t.state.prevPointerPosition,a=e.pageX-o.x,n=e.pageY-o.y;t.dragImage(a,n),t.setState({prevPointerPosition:new I.Point(e.pageX,e.pageY)})}}),v()(g()(g()(t)),"touchStart",function(e){t.props.enabled&&(e.preventDefault(),1===e.touches.length?t.saveSingleTouchPosition(e):2===e.touches.length&&(t.saveTouches(e),t.pinchInProgress=!0))}),v()(g()(g()(t)),"touchMove",function(e){t.props.enabled&&(e.preventDefault(),1===e.touches.length?t.touchDrag(e):2===e.touches.length&&t.props.allowZoom&&t.handlePinch(e))}),v()(g()(g()(t)),"saveSingleTouchPosition",function(e){var o=e.touches[0];t.setState({prevPointerPosition:new I.Point(o.pageX,o.pageY)})}),v()(g()(g()(t)),"touchDrag",function(e){var o=e.touches[0],a=t.state.prevPointerPosition,n=o.pageX-a.x,r=o.pageY-a.y;t.dragImage(n,r),t.saveSingleTouchPosition(e)}),v()(g()(g()(t)),"touchEnd",function(e){e.preventDefault(),1===e.touches.length&&t.saveSingleTouchPosition(e),1!==e.touches.length&&t.stopDragging(),2!==e.touches.length&&(t.pinchInProgress=!1)}),v()(g()(g()(t)),"touchCancel",function(){t.stopDragging(),t.pinchInProgress=!1}),v()(g()(g()(t)),"handlePinch",function(e){var o=e.touches[0],a=e.touches[1],n=new I.Point(o.pageX,o.pageY),r=new I.Point(a.pageX,a.pageY),i=t.prevTouchPositions.get(o.identifier),s=t.prevTouchPositions.get(a.identifier);if(i&&s){var c=n.distanceFrom(r),p=i.distanceFrom(s);if(p>0){var m=(c-p)/p,h=t.state,u=h.zoomCurrent,l=h.zoomMin,g=h.zoomMax,d=h.cropCenter,v=u+m*u;v=Object(I.boundNumber)(v,l,g);var f=t.zoomToSliderValue(v),z=t.adjustPointToKeepCropAreaFilled(d,v);t.setState({zoomCurrent:v,cropCenter:z,zoomSliderValue:f}),t.saveTouches(e)}}}),v()(g()(g()(t)),"saveTouches",function(e){Array.from(e.touches).forEach(function(e){return t.prevTouchPositions.set(e.identifier,new I.Point(e.pageX,e.pageY))})}),v()(g()(g()(t)),"dragImage",function(e,o){var a=t.state,n=a.cropCenter,r=a.zoomCurrent,i=e/r,s=o/r,c=new I.Point(n.x-i,n.y-s),p=t.adjustPointToKeepCropAreaFilled(c,r);t.setState({cropCenter:p})}),v()(g()(g()(t)),"adjustPointToKeepCropAreaFilled",function(e,o){var a=t.state,n=a.cropSize,r=a.imageSize,i=new I.Point(e.x,e.y),s=n.width/2/o,c=r.width-s,p=n.height/2/o,m=r.height-p;return i.x=Object(I.boundNumber)(i.x,s,c),i.y=Object(I.boundNumber)(i.y,p,m),i}),v()(g()(g()(t)),"zoomIncrement",function(){var e=t.state,o=e.zoomMin;return(e.zoomMax-o)/D}),v()(g()(g()(t)),"sliderValueToZoom",function(e){return t.state.zoomMin+t.zoomIncrement()*e}),v()(g()(g()(t)),"zoomToSliderValue",function(e){return(e-t.state.zoomMin)/t.zoomIncrement()}),v()(g()(g()(t)),"sliderChanged",function(e,o){if(!t.pinchInProgress){var a=o,n=t.sliderValueToZoom(a),r=t.state.cropCenter,i=t.adjustPointToKeepCropAreaFilled(r,n);t.setState({zoomSliderValue:a,zoomCurrent:n,cropCenter:i})}}),v()(g()(g()(t)),"render",function(){var e=t.props,o=e.cropShape,a=e.width,n=e.height,r=t.state,i=r.canvasSize,s=r.cropSize,c={width:s.width,height:s.height,top:(i.height-s.height)/2,left:(i.width-s.width)/2,borderRadius:"rectangle"===o?"0%":"100%"},p=t.state.imageLoaded?f.createElement("div",{style:c,className:M.cropShadow}):null,m=t.state.imageLoaded?null:f.createElement("div",{className:M.loadingSpinner},f.createElement(S.LoadingSpinner,{size:"large"})),h=t.props.allowZoom?f.createElement("div",{className:M.zoomWrap},f.createElement("span",{className:w()("ui_icon","photo",M.zoomIconSmall)}),f.createElement("div",{className:M.zoomSlider},f.createElement(b.Slider,{min:0,max:D-1,minHandleValue:0,maxHandleValue:t.state.zoomSliderValue,step:1,onChange:t.sliderChanged})),f.createElement("span",{className:"ui_icon photo ".concat(M.zoomIconBig)})):null;return f.createElement(f.Fragment,null,f.createElement("div",{style:{width:a,height:n},className:M.canvasWrapper},f.createElement("canvas",{className:M.canvas,ref:t.canvasRef,onMouseDown:t.mouseDown,onMouseUp:t.stopDragging,onMouseOut:t.stopDragging,onBlur:t.stopDragging,onMouseMove:t.mouseMove}),p,m),h,f.createElement(P.a,{callback:t.updateCanvas}))}),t.state={canvasSize:new I.Dimension(0,0),cropSize:new I.Dimension(0,0),imageLoaded:!1,imageSize:new I.Dimension(0,0),cropCenter:new I.Point(0,0),zoomMin:1,zoomMax:1,zoomCurrent:1,isDragging:!1,prevPointerPosition:new I.Point(0,0),zoomSliderValue:0},t}return u()(o,e),i()(o,[{key:"componentDidMount",value:function e(){if(this.setImage(),this.canvasRef.current){var o=this.canvasRef.current;o.addEventListener("touchstart",this.touchStart,{passive:!1}),o.addEventListener("touchmove",this.touchMove,{passive:!1}),o.addEventListener("touchend",this.touchEnd,{passive:!1}),o.addEventListener("touchcancel",this.touchCancel,{passive:!1})}}},{key:"componentDidUpdate",value:function e(o){o.url!==this.props.url?this.setImage():(this.updateCanvas(),this.props.cropImageNow&&this.cropImage())}}]),o}(f.Component);t.d(o,"Cropper",function(){return E})}}});
//# sourceMappingURL=media.cropper.268d04805d.js.map